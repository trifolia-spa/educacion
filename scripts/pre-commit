#!/usr/bin/env bash
# Pre-commit hook for educacion-trifolia slide deck.
# Checks staged files for common issues before allowing a commit.

set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
STAGED_FILES="$(git diff --cached --name-only --diff-filter=ACM)"

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

ERRORS=0

# ---------- 1. Merge conflict markers ----------
CONFLICT_FILES=$(echo "$STAGED_FILES" | grep -v '^scripts/pre-commit$' | xargs grep -l '<<<<<<< \|=======$\|>>>>>>> ' 2>/dev/null || true)
if [ -n "$CONFLICT_FILES" ]; then
  echo "ERROR: Merge conflict markers found in:"
  echo "$CONFLICT_FILES" | sed 's/^/  /'
  ERRORS=1
fi

# ---------- 2. Trailing whitespace ----------
TRAILING_WS=$(echo "$STAGED_FILES" | xargs grep -ln ' $' 2>/dev/null || true)
if [ -n "$TRAILING_WS" ]; then
  echo "WARNING: Trailing whitespace in:"
  echo "$TRAILING_WS" | sed 's/^/  /'
  # Warning only â€” don't block the commit
fi

# ---------- 3. JS syntax check ----------
JS_FILES=$(echo "$STAGED_FILES" | grep '\.js$' || true)
if [ -n "$JS_FILES" ]; then
  for f in $JS_FILES; do
    if ! node --check "$REPO_ROOT/$f" 2>/dev/null; then
      echo "ERROR: JS syntax error in $f"
      ERRORS=1
    fi
  done
fi

# ---------- 4. HTML lint ----------
HTML_FILES=$(echo "$STAGED_FILES" | grep '\.html$' || true)
if [ -n "$HTML_FILES" ]; then
  if command -v npx &>/dev/null; then
    HTML_ARGS=""
    for f in $HTML_FILES; do
      HTML_ARGS="$HTML_ARGS $REPO_ROOT/$f"
    done
    if ! npx --no-install htmlhint $HTML_ARGS; then
      echo "ERROR: HTMLHint found issues."
      ERRORS=1
    fi
  fi
fi

# ---------- 5. CSS lint ----------
CSS_FILES=$(echo "$STAGED_FILES" | grep '\.css$' || true)
if [ -n "$CSS_FILES" ]; then
  if command -v npx &>/dev/null; then
    CSS_ARGS=""
    for f in $CSS_FILES; do
      CSS_ARGS="$CSS_ARGS $REPO_ROOT/$f"
    done
    if ! npx --no-install stylelint $CSS_ARGS; then
      echo "ERROR: Stylelint found issues."
      ERRORS=1
    fi
  fi
fi

# ---------- 6. Navigation consistency ----------
if [ -n "$HTML_FILES" ]; then
  if ! node "$REPO_ROOT/scripts/validate-nav.js"; then
    ERRORS=1
  fi
fi

if [ "$ERRORS" -ne 0 ]; then
  echo ""
  echo "Commit blocked. Fix the errors above and try again."
  exit 1
fi
